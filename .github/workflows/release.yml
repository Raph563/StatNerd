name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate version file
        shell: bash
        run: |
          set -euo pipefail
          TAG_FULL="${GITHUB_REF_NAME#v}"
          TAG_VERSION="${TAG_FULL%%-*}"
          FILE_VERSION="$(tr -d '\r\n' < addon/VERSION)"
          if [ "$TAG_VERSION" != "$FILE_VERSION" ]; then
            echo "Tag version base ($TAG_VERSION) does not match addon/VERSION ($FILE_VERSION)"
            exit 1
          fi

          if printf '%s' "$TAG_FULL" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta)\.[0-9]+$'; then
            echo "IS_PRERELEASE=true" >> "$GITHUB_ENV"
          else
            echo "IS_PRERELEASE=false" >> "$GITHUB_ENV"
          fi

      - name: Build release archive
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          ARCHIVE="dist/statnerd-addon-${GITHUB_REF_NAME}.zip"
          zip -r "$ARCHIVE" addon
          echo "ARCHIVE=$ARCHIVE" >> "$GITHUB_ENV"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
          files: ${{ env.ARCHIVE }}

